<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask App - SQLite</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Loading overlay styles */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            margin: 0;
        }

        /* Disabled state for button */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="loading-text">ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</p>
        </div>
    </div>

    <div class="container">
        <!-- Sidebar l·ªãch s·ª≠ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>üìö L·ªãch s·ª≠</h2>
                <p id="historyCount">{{ history|length }} m·ª•c trong database</p>
            </div>

            <div class="action-buttons">
                <button class="clear-all-btn" onclick="if(confirm('X√≥a t·∫•t c·∫£ l·ªãch s·ª≠?')) window.location.href='{{ url_for('main.clear_history') }}'">
                    üóëÔ∏è X√≥a h·∫øt
                </button>
            </div>

            <div class="history-list" id="historyList">
                {% if history %}
                    {% for item in history %}
                    <div class="history-item {% if current_id == item.id %}active{% endif %}"
                         onclick="window.location.href='{{ url_for('main.view_content', history_id=item.id) }}'">
                        <button class="delete-btn" onclick="event.stopPropagation(); if(confirm('X√≥a m·ª•c n√†y?')) window.location.href='{{ url_for('main.delete_content', history_id=item.id) }}'">√ó</button>
                        <div class="title">{{ item.content }}</div>
                        <div class="time">{{ format_time(item.created_at) }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; padding: 20px; color: #95a5a6;">
                        Ch∆∞a c√≥ l·ªãch s·ª≠ n√†o
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Ph·∫ßn n·ªôi dung ch√≠nh -->
        <div class="main-content">
            <div class="content-header">
                <h1>üí¨ N·ªôi dung</h1>
            </div>

            <div class="content-body" id="contentBody">
                {% if current_content %}
                <div class="content-display">
                    <div class="meta">
                        <strong>üÜî ID:</strong> #{{ current_content.id }}
                        <strong>üïê Th·ªùi gian:</strong> {{ format_time(current_content.created_at) }}<br>
                    </div>
                    <div class="content-text">
                      Text : {{ current_content.content }}
                    </div>
                    <div class="content-text">
                      Sentiment : {{ current_content.sentiment }}
                    </div>
                </div>
                {% else %}
                <div class="empty-state">
                    <h2>üëã Ch√†o m·ª´ng!</h2>
                    <p>Nh·∫≠p n·ªôi dung b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                    <p style="margin-top: 10px; font-size: 0.9em;">D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u v√†o SQLite database</p>
                </div>
                {% endif %}
            </div>

            <div class="input-section">
                <form class="input-form" id="contentForm" novalidate>
                    <!-- Th√¥ng b√°o l·ªói n·∫±m tr√™n -->
                    <div id="errorMessage" class="error-message">Vui l√≤ng nh·∫≠p n·ªôi dung!</div>

                    <!-- Input + Button n·∫±m ngang -->
                    <div class="input-row">
                        <input type="text" id="contentInput" name="content" placeholder="Nh·∫≠p n·ªôi dung..." required>
                        <button type="submit" id="submitBtn">G·ª≠i</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
document.getElementById('contentForm').addEventListener('submit', async function(e) {
    e.preventDefault(); // Lu√¥n ngƒÉn submit m·∫∑c ƒë·ªãnh

    const input = document.getElementById('contentInput');
    const error = document.getElementById('errorMessage');
    const submitBtn = document.getElementById('submitBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');

    if (!input.value.trim()) {
        error.style.display = 'block';
        return;
    }

    error.style.display = 'none';

    // Hi·ªÉn th·ªã loading
    loadingOverlay.classList.add('active');
    submitBtn.disabled = true;
    input.disabled = true;
    submitBtn.textContent = 'ƒêang x·ª≠ l√Ω...';

    try {
        // G·ª≠i request AJAX
        const formData = new FormData();
        formData.append('content', input.value.trim());

        const response = await fetch('/add', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();

            // C·∫≠p nh·∫≠t giao di·ªán v·ªõi k·∫øt qu·∫£ m·ªõi
            updateContent(result);

            // X√≥a input
            input.value = '';

            // Reload ƒë·ªÉ c·∫≠p nh·∫≠t sidebar (ho·∫∑c b·∫°n c√≥ th·ªÉ c·∫≠p nh·∫≠t ƒë·ªông)
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            alert('C√≥ l·ªói x·∫£y ra! Vui l√≤ng th·ª≠ l·∫°i.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!');
    } finally {
        // ·∫®n loading v√† enable l·∫°i controls
        loadingOverlay.classList.remove('active');
        submitBtn.disabled = false;
        input.disabled = false;
        submitBtn.textContent = 'G·ª≠i';
    }
});

function updateContent(data) {
    const contentBody = document.getElementById('contentBody');
    contentBody.innerHTML = `
        <div class="content-display">
            <div class="meta">
                <strong>üÜî ID:</strong> #${data.id}
                <strong>üïê Th·ªùi gian:</strong> ${data.time}<br>
            </div>
            <div class="content-text">
              Text : ${data.content}
            </div>
            <div class="content-text">
              Sentiment : ${data.sentiment}
            </div>
        </div>
    `;
}
</script>

</body>
</html>